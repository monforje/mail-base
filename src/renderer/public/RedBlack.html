<!DOCTYPE html>
<html>
  <head>
    <title>Red/Black Tree Visualization</title>
    <meta charset="UTF-8" />

    <!-- –ü—Ä—è–º—ã–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –≤ src/renderer -->
    <script src="ThirdParty/jquery-1.5.2.min.js"></script>
    <script src="ThirdParty/jquery-ui-1.8.11.custom.min.js"></script>

    <!-- Javascript –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ -->
    <script
      type="text/javascript"
      src="AnimationLibrary/CustomEvents.js"
    ></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/UndoFunctions.js"
    ></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/AnimatedObject.js"
    ></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/AnimatedLabel.js"
    ></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/AnimatedCircle.js"
    ></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/AnimatedRectangle.js"
    ></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/AnimatedLinkedList.js"
    ></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/HighlightCircle.js"
    ></script>
    <script type="text/javascript" src="AnimationLibrary/Line.js"></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/ObjectManager.js"
    ></script>
    <script
      type="text/javascript"
      src="AnimationLibrary/AnimationMain.js"
    ></script>

    <script type="text/javascript" src="AlgorithmLibrary/Algorithm.js"></script>
    <script type="text/javascript" src="AlgorithmLibrary/RedBlack.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      #container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      #header h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
      }
      #canvas {
        border: 2px solid #ddd;
        background-color: white;
        display: block;
        margin: 0 auto;
        cursor: grab;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }
      #canvas:active {
        cursor: grabbing;
      }
      #canvas-container {
        overflow: hidden;
        position: relative;
        border: 2px solid #ddd;
        margin: 0 auto;
        width: 1000px;
        height: 500px;
        background-color: white;
      }
      table {
        margin: 10px auto;
      }
      button,
      input {
        margin: 0 5px;
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 3px;
      }
      button {
        background-color: #007cba;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #005a87;
      }
      #status {
        text-align: center;
        padding: 10px;
        margin: 10px 0;
        background-color: #e3f2fd;
        border-radius: 4px;
        color: #1565c0;
      }
    </style>

    <script>
      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
      window.packagesToLoad = [];
      window.treeInitialized = false;

      // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—ã—Å–æ–∫–æ–≥–æ DPI –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
      window.canvasScale = 1;
      window.canvasOffset = { x: 0, y: 0 };
      window.isDragging = false;
      window.lastMousePos = { x: 0, y: 0 };

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å–æ–∫–æ–≥–æ DPI
      function setupHighDPICanvas(canvas) {
        const ctx = canvas.getContext("2d");
        const devicePixelRatio = window.devicePixelRatio || 1;
        const backingStoreRatio =
          ctx.webkitBackingStorePixelRatio ||
          ctx.mozBackingStorePixelRatio ||
          ctx.msBackingStorePixelRatio ||
          ctx.oBackingStorePixelRatio ||
          ctx.backingStorePixelRatio ||
          1;

        const ratio = devicePixelRatio / backingStoreRatio;

        if (devicePixelRatio !== backingStoreRatio) {
          const oldWidth = canvas.width;
          const oldHeight = canvas.height;

          canvas.width = oldWidth * ratio;
          canvas.height = oldHeight * ratio;

          canvas.style.width = oldWidth + "px";
          canvas.style.height = oldHeight + "px";

          ctx.scale(ratio, ratio);
        }

        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";

        window.canvasScale = ratio;
        console.log(`Canvas DPI –Ω–∞—Å—Ç—Ä–æ–µ–Ω: ratio = ${ratio}`);

        return ctx;
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞–Ω–≤–∞—Å–∞
      function setupCanvasPanning(canvas) {
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;
        let translateX = 0;
        let translateY = 0;
        let scale = 1;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—ã—à–∏
        canvas.addEventListener("mousedown", function (e) {
          isDragging = true;
          lastX = e.clientX;
          lastY = e.clientY;
          canvas.style.cursor = "grabbing";
          e.preventDefault();
        });

        canvas.addEventListener("mousemove", function (e) {
          if (!isDragging) return;

          const deltaX = e.clientX - lastX;
          const deltaY = e.clientY - lastY;

          translateX += deltaX;
          translateY += deltaY;

          // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é
          updateCanvasTransform();

          lastX = e.clientX;
          lastY = e.clientY;
          e.preventDefault();
        });

        canvas.addEventListener("mouseup", function (e) {
          isDragging = false;
          canvas.style.cursor = "grab";
        });

        canvas.addEventListener("mouseleave", function (e) {
          isDragging = false;
          canvas.style.cursor = "grab";
        });

        // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
        canvas.addEventListener("wheel", function (e) {
          e.preventDefault();

          const rect = canvas.getBoundingClientRect();
          const mouseX = e.clientX - rect.left;
          const mouseY = e.clientY - rect.top;

          const wheel = e.deltaY < 0 ? 1.1 : 0.9;
          const newScale = scale * wheel;

          // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
          if (newScale >= 0.5 && newScale <= 3) {
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∑–∏—Ü–∏–∏ –º—ã—à–∏
            translateX = mouseX - (mouseX - translateX) * wheel;
            translateY = mouseY - (mouseY - translateY) * wheel;
            scale = newScale;

            updateCanvasTransform();
          }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateCanvasTransform() {
          canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touch –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        canvas.addEventListener("touchstart", function (e) {
          if (e.touches.length === 1) {
            isDragging = true;
            const touch = e.touches[0];
            lastX = touch.clientX;
            lastY = touch.clientY;
            e.preventDefault();
          }
        });

        canvas.addEventListener("touchmove", function (e) {
          if (!isDragging || e.touches.length !== 1) return;

          const touch = e.touches[0];
          const deltaX = touch.clientX - lastX;
          const deltaY = touch.clientY - lastY;

          translateX += deltaX;
          translateY += deltaY;

          updateCanvasTransform();

          lastX = touch.clientX;
          lastY = touch.clientY;
          e.preventDefault();
        });

        canvas.addEventListener("touchend", function (e) {
          isDragging = false;
        });

        // –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏ –∏ –º–∞—Å—à—Ç–∞–±–∞
        window.resetCanvasPosition = function () {
          translateX = 0;
          translateY = 0;
          scale = 1;
          updateCanvasTransform();
        };

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–æ–º
        window.zoomIn = function () {
          if (scale < 3) {
            scale *= 1.2;
            updateCanvasTransform();
          }
        };

        window.zoomOut = function () {
          if (scale > 0.5) {
            scale *= 0.8;
            updateCanvasTransform();
          }
        };

        console.log("Canvas panning –∏ zoom –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã");
      }

      // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞
      window.addEventListener("message", function (event) {
        console.log("RedBlack.html: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ", event.data);

        if (event.data && event.data.type === "LOAD_PACKAGES") {
          window.packagesToLoad = event.data.packages || [];
          console.log(
            `RedBlack.html: –ü–æ–ª—É—á–µ–Ω–æ ${window.packagesToLoad.length} –ø–æ—Å—ã–ª–æ–∫`
          );

          // –ï—Å–ª–∏ –¥–µ—Ä–µ–≤–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É
          if (window.treeInitialized && typeof currentAlg !== "undefined") {
            loadPackagesIntoTree();
          }
        }
      });

      // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—ã–ª–æ–∫ –≤ –¥–µ—Ä–µ–≤–æ
      function loadPackagesIntoTree() {
        if (!window.packagesToLoad || window.packagesToLoad.length === 0) {
          console.log("RedBlack.html: –ù–µ—Ç –ø–æ—Å—ã–ª–æ–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏");
          return;
        }

        if (typeof currentAlg === "undefined" || !currentAlg) {
          console.error("RedBlack.html: currentAlg –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω");
          return;
        }

        console.log(
          `RedBlack.html: –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É ${window.packagesToLoad.length} –ø–æ—Å—ã–ª–æ–∫`
        );

        // –û—á–∏—â–∞–µ–º –¥–µ—Ä–µ–≤–æ
        try {
          if (typeof currentAlg.clearCallback === "function") {
            currentAlg.clearCallback();
          }
        } catch (e) {
          console.warn("RedBlack.html: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –¥–µ—Ä–µ–≤–æ:", e);
        }

        // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π
        const uniqueSenders = [
          ...new Set(
            window.packagesToLoad.map((pkg) => pkg.senderPhone.toString())
          ),
        ];
        console.log(
          `RedBlack.html: –ù–∞–π–¥–µ–Ω–æ ${uniqueSenders.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π`
        );

        // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        uniqueSenders.forEach((senderPhone, index) => {
          setTimeout(() => {
            try {
              console.log(
                `RedBlack.html: –í—Å—Ç–∞–≤–ª—è–µ–º –∫–ª—é—á ${index + 1}/${
                  uniqueSenders.length
                }: ${senderPhone}`
              );

              const commands = currentAlg.insertElement(senderPhone);
              if (commands && currentAlg.animationManager) {
                currentAlg.animationManager.StartNewAnimation(commands);
                currentAlg.animationManager.skipForward();
                currentAlg.animationManager.clearHistory();
              }
            } catch (error) {
              console.error(
                `RedBlack.html: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ ${senderPhone}:`,
                error
              );
            }
          }, index * 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –≤—Å—Ç–∞–≤–∫–∞–º–∏
        });

        updateStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${uniqueSenders.length} –∫–ª—é—á–µ–π –≤ –¥–µ—Ä–µ–≤–æ`);
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
      function updateStatus(message) {
        const statusDiv = document.getElementById("status");
        if (statusDiv) {
          statusDiv.textContent = message;
        }
        console.log("RedBlack.html: " + message);
      }

      // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π init
      function setupInit() {
        // –ñ–¥–µ–º –ø–æ–∫–∞ init —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω
        if (typeof window.init === "function") {
          const originalInit = window.init;

          window.init = function () {
            console.log("RedBlack.html: –í—ã–∑–æ–≤ init()");
            updateStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ä–µ–≤–∞...");

            try {
              // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
              originalInit();

              window.treeInitialized = true;
              updateStatus("–î–µ—Ä–µ–≤–æ –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö");

              // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å
              setTimeout(() => {
                loadPackagesIntoTree();
              }, 500);
            } catch (error) {
              console.error("RedBlack.html: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
              updateStatus("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–µ—Ä–µ–≤–∞");
            }
          };

          console.log("RedBlack.html: init() –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω");
        } else {
          // –ï—Å–ª–∏ init –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞
          setTimeout(setupInit, 100);
        }
      }

      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      document.addEventListener("DOMContentLoaded", function () {
        console.log("RedBlack.html: DOM –∑–∞–≥—Ä—É–∂–µ–Ω");
        updateStatus("–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫...");

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–Ω–≤–∞—Å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        setTimeout(() => {
          const canvas = document.getElementById("canvas");
          if (canvas) {
            console.log("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã—Å–æ–∫–æ–≥–æ DPI –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞–Ω–≤–∞—Å–∞...");
            setupHighDPICanvas(canvas);
            setupCanvasPanning(canvas);
          }
        }, 100);

        setupInit();
      });

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      function manualLoad() {
        loadPackagesIntoTree();
      }
    </script>
  </head>

  <body onload="init();">
    <div id="container">
      <div id="header">
        <h1>Red/Black Tree - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å—ã–ª–æ–∫</h1>
      </div>

      <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

      <div id="mainContent">
        <div id="algoControlSection">
          <table id="AlgorithmSpecificControls"></table>
        </div>

        <div id="canvas-container">
          <canvas id="canvas" width="2000" height="1000"></canvas>
        </div>

        <div id="generalAnimationControlSection">
          <table id="GeneralAnimationControls"></table>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div style="text-align: center; margin-top: 10px">
          <button onclick="manualLoad()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
          <button
            onclick="window.resetCanvasPosition && window.resetCanvasPosition()"
          >
            –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
          </button>
          <button onclick="window.zoomIn && window.zoomIn()">–£–≤–µ–ª–∏—á–∏—Ç—å</button>
          <button onclick="window.zoomOut && window.zoomOut()">
            –£–º–µ–Ω—å—à–∏—Ç—å
          </button>
          <button
            onclick="console.log('currentAlg:', typeof currentAlg, currentAlg)"
          >
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å currentAlg
          </button>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
        <div
          style="
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
          "
        >
          üí° –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –º—ã—à–∫–æ–π ‚Ä¢ –ö–æ–ª–µ—Å–∏–∫–æ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∞ ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ touch –Ω–∞
          –º–æ–±–∏–ª—å–Ω—ã—Ö
        </div>
      </div>

      <div
        id="footer"
        style="text-align: center; color: #666; margin-top: 20px"
      >
        <p>–ö–ª—é—á–∏ –¥–µ—Ä–µ–≤–∞: –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π</p>
      </div>
    </div>
  </body>
</html>
